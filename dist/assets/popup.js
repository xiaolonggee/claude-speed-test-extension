import{c as P,i as G,u as J,r as f,j as e,L,C as W,B as S,a as X,b as Y,S as ee,d as te,e as B,f as O,g as se,s as ae,h as re,R as ne}from"./index.js";const le=P("AlertTriangle",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z",key:"c3ski4"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),oe=P("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]),ie=P("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),ce=async a=>{if(!G)throw new Error("需要在浏览器扩展环境中运行测速");const t=await new Promise((b,w)=>{chrome.runtime.sendMessage({type:"TEST_REQUEST",payload:a},h=>{if(chrome.runtime.lastError){w(chrome.runtime.lastError);return}b(h)})});if(!(t!=null&&t.success)||!t.data)throw new Error((t==null?void 0:t.error)||"测速失败");if(t.data.success===!1)throw new Error(t.data.error||"测速失败");return t.data},de=a=>({model:a.model,max_tokens:a.maxTokens||1024,stream:!0,messages:[{role:"user",content:a.content||"Hello"}]}),ue=a=>{const t=a.filter(s=>s.success),b=a.length-t.length,w=a.length===0?0:t.length/a.length*100,h=t.length===0?0:t.reduce((s,p)=>s+p.firstByteTime,0)/t.length,j=t.length===0?0:Math.min(...t.map(s=>s.firstByteTime)),T=t.length===0?0:Math.max(...t.map(s=>s.firstByteTime)),N=t.length===0?0:t.reduce((s,p)=>s+p.totalTime,0)/t.length;let x;for(let s=a.length-1;s>=0;s-=1)if(!a[s].success){x=a[s].error;break}let v;for(let s=a.length-1;s>=0;s-=1)if(a[s].success){v=a[s].firstMessage??"";break}return{avgFirst:h,bestFirst:j,worstFirst:T,avgTotal:N,failures:b,lastError:x,successRate:w,lastMessage:v}},me=()=>{const{config:a,setConfig:t,persist:b,loading:w,error:h}=J(),[j,T]=f.useState(!1),[N,x]=f.useState({}),[v,s]=f.useState({}),[p,y]=f.useState(null),[A,D]=f.useState("zh"),i=f.useRef(0),F=["claude-3-5-haiku-20241022","claude-3-5-sonnet-20241022","claude-haiku-4-5-20251001","claude-opus-4-20250514","claude-sonnet-4-20250514","claude-sonnet-4-5","claude-3-7-sonnet-20250219","claude-opus-4-1-20250805","claude-opus-4-5-20251101","claude-sonnet-4-5-20250929"],d=n=>({zh:{title:"测速",bannerNoRoute:"请至少开启一条线路",bannerNoToken:"请填写全局 API Key 或为线路单独设置认证头",bannerDone:"测速完成",bannerError:"测速出现异常",loading:"正在载入配置...",sample:"示例",first:"首字",total:"总时",fail:"失败",progress:"进度",noText:"未返回文本",startAria:"开始测速",toggleLang:"中/EN"},en:{title:"Speed Test",bannerNoRoute:"Enable at least one route",bannerNoToken:"Set global API key or per-route auth",bannerDone:"Tests finished",bannerError:"Test error",loading:"Loading config...",sample:"Sample",first:"First byte",total:"Total",fail:"Fails",progress:"Progress",noText:"No text returned",startAria:"Start test",toggleLang:"中/EN"}})[A][n]||n;f.useEffect(()=>{h&&y(h)},[h]);const z=async n=>{const o=++i.current,l=n||a,g=l.routes.filter(r=>r.enabled);if(g.length===0){o===i.current&&y(null);return}if(!g.some(r=>(r.authHeader||l.apiKey).trim())){y(null);return}T(!0),y(null),x({}),s({});const k=de(l),K=Math.max(1,Math.min(l.maxConcurrentRoutes||1,g.length));let E=0;const q=async r=>{const m=[],$=se(r.authHeader||l.apiKey||""),Q=Math.max(1,Math.min(l.maxConcurrentPerRoute||1,l.testCount));let I=0,M=0;const U=async()=>{for(;o===i.current;){const R=I;if(I+=1,R>=l.testCount)break;try{const u=await ce({url:r.url,payload:k,token:$,timeout:l.timeout}),C=(u.fullText||u.firstChunkText||"").trim();C?m.push({success:!0,totalTime:u.totalTime,firstByteTime:u.firstByteTime,timestamp:Date.now(),firstMessage:C}):m.push({success:!1,error:"未返回文本",totalTime:u.totalTime,firstByteTime:u.firstByteTime,timestamp:Date.now(),firstMessage:""}),o===i.current&&x(Z=>({...Z,[r.id]:{route:r,runs:[...m]}}))}catch(u){m.push({success:!1,error:u.message,totalTime:0,firstByteTime:0,timestamp:Date.now(),firstMessage:""}),o===i.current&&x(C=>({...C,[r.id]:{route:r,runs:[...m]}}))}M+=1,o===i.current&&s(u=>({...u,[r.id]:M})),l.delayBetweenTests>0&&M<l.testCount&&await ae(l.delayBetweenTests*1e3)}};return await Promise.all(Array.from({length:Q},()=>U())),x(R=>({...R,[r.id]:{route:r,runs:m}})),o===i.current},V=async()=>{for(;E<g.length&&o===i.current;){const r=E;E+=1;const m=g[r];await q(m)}};try{const r=Array.from({length:K},()=>V());await Promise.all(r),o===i.current&&y(null)}catch(r){o===i.current&&y(r.message||null)}finally{o===i.current&&T(!1)}},H=async n=>{const o=n.target.value,l={...a,model:o};t(l),await b(l),await z(l)},_=()=>{var n;typeof chrome<"u"&&((n=chrome.runtime)!=null&&n.openOptionsPage)?chrome.runtime.openOptionsPage():window.open("/options.html","_blank")};return w?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(L,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{children:d("loading")})]})}):e.jsx("div",{className:"min-h-screen",children:e.jsx("div",{className:"mx-auto flex max-w-6xl flex-col gap-4 px-5 py-6",children:e.jsxs(W,{className:"glass-panel relative",children:[e.jsx(S,{type:"button",variant:"ghost",size:"icon",className:"absolute right-3 top-3 border border-border/70 bg-white/90 text-muted-foreground shadow-sm hover:text-foreground",onClick:_,"aria-label":"打开选项页",children:e.jsx(ie,{className:"h-4 w-4"})}),e.jsxs(X,{className:"pb-2",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3 pr-12",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{variant:"ghost",size:"sm",className:"text-xs",onClick:()=>D(A==="zh"?"en":"zh"),children:d("toggleLang")}),e.jsx(Y,{children:d("title")})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ee,{value:a.model,onChange:H,className:"h-10 min-w-[200px] text-xs",children:F.map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsx(S,{onClick:()=>z(),disabled:j,size:"icon","aria-label":d("startAria"),className:"h-10 w-10 rounded-full",children:j?e.jsx(L,{className:"h-4 w-4 animate-spin"}):e.jsx(oe,{className:"h-4 w-4"})})]})]}),p&&e.jsx("div",{className:"text-xs text-muted-foreground",children:p})]}),e.jsx(te,{className:"space-y-3",children:Object.keys(N).length>0&&e.jsx("div",{className:"rounded-xl border border-border bg-white/90 shadow-sm",children:Object.values(N).map(({route:n,runs:o},l,g)=>{const c=ue(o),k=c.failures===0?"text-success":c.failures===o.length?"text-destructive":"text-warning-foreground";return e.jsxs("div",{className:B("flex flex-col gap-2 px-3 py-2 text-sm",l!==g.length-1&&"border-b border-border/70"),children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:B("h-2.5 w-2.5 rounded-full",k.replace("text","bg"))}),e.jsx("span",{className:B("max-w-[260px] truncate text-[12px] font-semibold",k),title:`${n.url}`,children:n.url})]}),e.jsxs("div",{className:"flex items-center gap-3 text-[11px] text-muted-foreground",children:[e.jsxs("span",{children:[d("first")," ",O(c.avgFirst||0)]}),e.jsxs("span",{children:[d("total")," ",O(c.avgTotal||0)]}),e.jsxs("span",{children:[d("fail")," ",c.failures]}),e.jsxs("span",{children:[d("progress")," ",v[n.id]||0,"/",a.testCount]})]})]}),c.lastMessage!==void 0&&e.jsxs("div",{className:"text-[12px] text-foreground",children:[e.jsxs("span",{className:"font-semibold text-muted-foreground mr-1",children:[d("sample"),":"]}),e.jsx("span",{className:"break-words",children:c.lastMessage.trim()?c.lastMessage:d("noText")})]}),c.lastError&&e.jsxs("div",{className:"flex items-center gap-2 text-[12px] text-warning-foreground",children:[e.jsx(le,{className:"h-3.5 w-3.5"}),c.lastError]})]},n.id)})})})]})})})};re.createRoot(document.getElementById("root")).render(e.jsx(ne.StrictMode,{children:e.jsx(me,{})}));
